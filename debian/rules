#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

export XDG_CONFIG_HOME=$HOME/.config
export BUILD = Release

DESTDIR = debian/lfmerge
LIB     = usr/lib/lfmerge
SHARE   = usr/share/lfmerge

%:
	dh $@ --with=cli --parallel

override_dh_auto_configure:

override_dh_auto_build:
	. ./environ && \
		xbuild /p:Configuration=$(BUILD) /t:Build build/LfMerge.proj

override_dh_auto_test:

override_dh_auto_clean:
	. ./environ && \
		xbuild /p:Configuration=$(BUILD) /t:Clean build/LfMerge.proj
	dh_clean

override_dh_auto_install:
	# Install binaries
	install -d $(DESTDIR)/$(LIB)
	install -m 644 output/$(BUILD)/*.* $(DESTDIR)/$(LIB)
	cd $(DESTDIR)/$(LIB) && rm *.Tests.dll* *.TestApp.exe* SIL.TestUtilities.dll* nunit.framework.dll
	# Install environ file
	install -d $(DESTDIR)/$(SHARE)
	install -m 644 environ $(DESTDIR)/$(SHARE)
	# Install wrapper script
	install -d $(DESTDIR)/usr/bin
	install -m 755 lfmerge $(DESTDIR)/usr/bin

# Don't export any assemblies to other packages
override_dh_makeclilibs:

# Include mono-sil in shlib dirs searched
override_dh_shlibdeps:
	dh_shlibdeps -l$(MONO_PREFIX)/lib

# Include mono-sil in cli dirs searched
override_dh_clideps:
	dh_clideps -l$(MONO_PREFIX)/lib \
		--exclude-moduleref=security.dll

# Don't strip debug symbols -- we want them for informative crash stack traces
override_dh_strip:

override_dh_clistrip:
