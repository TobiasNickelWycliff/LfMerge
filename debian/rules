#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

export XDG_CONFIG_HOME=$HOME/.config
export BUILD = Release

DESTDIR = debian/lfmerge
LIB     = usr/lib/lfmerge
SHARE   = usr/share/lfmerge

%:
	dh $@ --with=cli --parallel

override_dh_auto_configure:

override_dh_auto_build:
	# see also https://bugzilla.xamarin.com/show_bug.cgi?id=21298#c10
	. ./environ && \
		mozroots --import --sync && \
		yes | certmgr -ssl https://go.microsoft.com && \
		yes | certmgr -ssl https://nugetgallery.blob.core.windows.net && \
		yes | certmgr -ssl https://nuget.org && \
		xbuild /p:Configuration=$(BUILD) /t:Build build/LfMerge.proj

override_dh_auto_test:

override_dh_auto_clean:
	. ./environ && \
		xbuild /p:Configuration=$(BUILD) /t:Clean build/LfMerge.proj
	dh_clean

override_dh_auto_install:
	# Install binaries
	install -d $(DESTDIR)/$(LIB)
	install -m 644 output/$(BUILD)/*.* $(DESTDIR)/$(LIB)
	cd $(DESTDIR)/$(LIB) && rm *.Tests.dll* *.TestApp.exe* SIL.TestUtilities.dll* nunit.framework.dll *Moq.dll
	install -d $(DESTDIR)/$(LIB)/Mercurial
	install -d $(DESTDIR)/$(LIB)/Mercurial/hgext
	install -d $(DESTDIR)/$(LIB)/Mercurial/mercurial
	install -d $(DESTDIR)/$(LIB)/MercuralExtensions
	install -m 755 Mercurial/hg $(DESTDIR)/$(LIB)/Mercurial
	install -m 644 Mercurial/mercurial.ini $(DESTDIR)/$(LIB)/Mercurial
	install -m 644 Mercurial/hgext/*.* $(DESTDIR)/$(LIB)/Mercurial/hgext
	install -m 644 Mercurial/mercurial/*.* $(DESTDIR)/$(LIB)/Mercurial/mercurial
	install -m 644 MercurialExtensions/**/*.* $(DESTDIR)/$(LIB)/MercuralExtensions
	# Install environ file
	install -d $(DESTDIR)/$(SHARE)
	install -m 644 environ $(DESTDIR)/$(SHARE)
	install -d $(DESTDIR)/$(SHARE)/Mercurial/doc
	install -m 644 Mercurial/doc/*.* $(DESTDIR)/$(SHARE)/Mercurial/doc
	# Install wrapper script
	install -d $(DESTDIR)/usr/bin
	install -m 755 lfmerge $(DESTDIR)/usr/bin
	# Install conf file
	install -d $(DESTDIR)/etc/languageforge/conf
	install -m 644 debian/sendreceive.conf $(DESTDIR)/etc/languageforge/conf
	# Create working directories
	mkdir -p $(DESTDIR)/var/lib/languageforge/lexicon/sendreceive/state
	mkdir -p $(DESTDIR)/var/lib/languageforge/lexicon/sendreceive/webwork
	mkdir -p $(DESTDIR)/var/lib/languageforge/lexicon/sendreceive/mergequeue
	mkdir -p $(DESTDIR)/var/lib/languageforge/lexicon/sendreceive/commitqueue
	mkdir -p $(DESTDIR)/var/lib/languageforge/lexicon/sendreceive/receivequeue
	mkdir -p $(DESTDIR)/var/lib/languageforge/lexicon/sendreceive/sendqueue
	mkdir -p $(DESTDIR)/var/lib/languageforge/lexicon/sendreceive/ReleaseData
	mkdir -p $(DESTDIR)/var/lib/languageforge/lexicon/sendreceive/Templates

# Don't export any assemblies to other packages
override_dh_makeclilibs:

# Include mono-sil in shlib dirs searched
override_dh_shlibdeps:
	dh_shlibdeps -l$(MONO_PREFIX)/lib

# Include mono-sil in cli dirs searched
override_dh_clideps:
	dh_clideps -l$(MONO_PREFIX)/lib \
		--exclude-moduleref=security.dll \
		--exclude-moduleref=icuuc52.dll --exclude-moduleref=icuin52.dll \
		--exclude-moduleref=icuuc48.dll --exclude-moduleref=icuin48.dll \
		--exclude-moduleref=libhunspell \
		--exclude-moduleref=libicuuc.so --exclude-moduleref=libicui18n.so

# Don't strip debug symbols -- we want them for informative crash stack traces
override_dh_strip:

override_dh_clistrip:
